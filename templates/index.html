<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compress â€” Make your PDFs email-ready</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #f9f4eb;
            --text: #120F08;
            --text-60: rgba(18, 15, 8, 0.6);
            --text-40: rgba(18, 15, 8, 0.4);
            --text-20: rgba(18, 15, 8, 0.2);
            --text-10: rgba(18, 15, 8, 0.1);
            --text-06: rgba(18, 15, 8, 0.06);
            --brand: #0021cc;
            --brand-light: rgba(0, 33, 204, 0.06);
            --brand-mid: rgba(0, 33, 204, 0.12);
            --brand-20: rgba(0, 33, 204, 0.2);
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        /* â”€â”€ Header â”€â”€ */
        .header { text-align: center; margin-bottom: 48px; }

        .logo {
            display: flex;
            justify-content: center;
            margin-bottom: 28px;
        }

        .logo-icon {
            width: 32px; height: 32px; border-radius: 8px;
            background: var(--brand);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 15px;
        }

        .logo-text { font-size: 15px; color: var(--text); letter-spacing: -0.01em; }

        .headline {
            font-size: 38px; font-weight: 400; line-height: 1.15;
            letter-spacing: -0.03em; margin-bottom: 14px;
            white-space: nowrap;
        }

        .subline {
            font-size: 15px; color: var(--text-60); line-height: 1.55;
            max-width: 420px; margin: 0 auto;
        }

        /* â”€â”€ Steps â”€â”€ */
        .steps {
            display: flex; align-items: center; justify-content: center;
            gap: 6px; margin-bottom: 28px;
        }

        .step { display: flex; align-items: center; gap: 6px; }

        .step-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: var(--text-20); transition: background 0.3s;
        }
        .step-dot.active { background: var(--brand); }

        .step-label { font-size: 12px; color: var(--text-40); transition: color 0.3s; }
        .step-label.active { color: var(--text); }

        .step-line { width: 20px; height: 1px; background: var(--text-10); }
        .step-line.active { background: var(--brand-mid); }

        /* â”€â”€ Sections â”€â”€ */
        .section { display: none; animation: fadeIn 0.35s ease; }
        .section.visible { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ Drop Zone â”€â”€ */
        .dropzone {
            border: 2px dashed var(--text-20); border-radius: 14px;
            padding: 56px 32px; text-align: center;
            cursor: pointer; transition: all 0.25s;
        }
        .dropzone:hover, .dropzone.dragging {
            border-color: var(--brand); background: var(--brand-light);
        }

        .dropzone-arrow {
            font-size: 40px; margin-bottom: 14px; opacity: 0.6;
            transition: opacity 0.25s;
        }
        .dropzone:hover .dropzone-arrow { opacity: 1; }

        .dropzone-title { font-size: 17px; color: var(--text); margin-bottom: 6px; }
        .dropzone-sub { font-size: 13px; color: var(--text-40); }

        /* â”€â”€ Cards â”€â”€ */
        .card {
            background: transparent; border-radius: 12px;
            border: none; padding: 20px 0; margin-top: 28px;
        }

        .card-title { font-size: 13px; color: var(--text); margin-bottom: 14px; }

        .preserves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .preserve-item {
            font-size: 13px; color: var(--text-60);
            display: flex; align-items: center; gap: 8px;
        }

        .preserve-check {
            width: 16px; height: 16px; border-radius: 4px;
            background: var(--brand-light); color: var(--brand);
            font-size: 9px; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0;
        }

        /* â”€â”€ File Info â”€â”€ */
        .file-info {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 18px; background: transparent;
            border-radius: 12px; border: 1px solid var(--text-10);
            margin-bottom: 28px;
        }

        .file-icon {
            width: 42px; height: 42px; border-radius: 10px;
            background: var(--brand-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }

        .file-details { flex: 1; min-width: 0; }

        .file-name {
            font-size: 14px; color: var(--text);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .file-size { font-size: 13px; color: var(--text-40); }

        .file-remove {
            background: none; border: none; cursor: pointer;
            font-size: 18px; color: var(--text-40); padding: 4px 8px;
        }
        .file-remove:hover { color: var(--text); }

        /* â”€â”€ Slider â”€â”€ */
        .slider-section { margin-bottom: 28px; }

        .slider-header {
            display: flex; justify-content: space-between;
            align-items: baseline; margin-bottom: 16px;
        }

        .slider-label { font-size: 13px; color: var(--text); }

        .slider-level-name { font-size: 13px; color: var(--brand); }

        .slider-track {
            position: relative;
            padding: 0 0 8px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--text-10);
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--brand);
            border: 3px solid var(--white);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.15s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        input[type="range"]::-moz-range-thumb {
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--brand);
            border: 3px solid var(--white);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .slider-ticks {
            display: flex; justify-content: space-between;
            padding: 6px 0 0;
        }

        .slider-tick {
            font-size: 11px; color: var(--text-40);
        }

        .slider-tick:first-child { text-align: left; }
        .slider-tick:last-child { text-align: right; }

        /* â”€â”€ Level Description â”€â”€ */
        .level-desc {
            padding: 16px 20px;
            background: transparent;
            border-radius: 12px;
            border: 1px solid var(--text-10);
            margin-bottom: 28px;
            transition: all 0.2s;
        }

        .level-desc-text {
            font-size: 13px;
            color: var(--text-60);
            line-height: 1.5;
            margin-bottom: 14px;
        }

        .settings-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px; font-size: 13px; color: var(--text-60);
        }

        .settings-value { color: var(--brand); }

        /* â”€â”€ Buttons â”€â”€ */
        .btn-primary {
            width: 100%; padding: 15px;
            background: var(--brand); color: white;
            border: none; border-radius: 12px;
            font-size: 15px; font-family: 'Inter', sans-serif; font-weight: 400;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-primary:hover { background: #001aa3; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            width: auto; padding: 15px 24px;
            background: transparent; color: var(--text);
            border: 2px solid var(--text-10); border-radius: 12px;
            font-size: 15px; font-family: 'Inter', sans-serif; font-weight: 400;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: var(--text-20); }

        .btn-row { display: flex; gap: 12px; margin-top: 24px; }

        /* â”€â”€ Progress â”€â”€ */
        .progress-section { text-align: center; padding: 48px 0; }

        .progress-ring-wrap {
            position: relative; display: inline-block; margin-bottom: 28px;
        }

        .progress-pct {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px; color: var(--brand);
        }

        .progress-label { font-size: 15px; color: var(--text); margin-bottom: 6px; }
        .progress-sub { font-size: 13px; color: var(--text-40); }

        /* â”€â”€ Results â”€â”€ */
        .result-card {
            background: transparent; border-radius: 16px;
            padding: 32px 0; border: none;
        }

        .result-layout {
            display: flex; align-items: center; justify-content: center;
            gap: 48px; flex-wrap: wrap;
        }

        .result-ring { text-align: center; }

        .result-pct {
            font-size: 28px; color: var(--brand);
            margin-top: -78px; margin-bottom: 52px;
        }

        .result-pct-label { font-size: 13px; color: var(--text-40); }

        .result-sizes { display: flex; flex-direction: column; gap: 16px; }

        .result-size-label {
            font-size: 11px; color: var(--text-40);
            text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px;
        }

        .result-size-value { font-size: 20px; color: var(--text); }
        .result-size-value.compressed { color: var(--brand); }

        .result-divider { width: 100%; height: 1px; background: var(--text-06); }

        .result-badges {
            margin-top: 24px; padding: 12px 16px;
            background: var(--bg); border-radius: 8px;
            display: flex; gap: 18px; justify-content: center; flex-wrap: wrap;
        }

        .result-badge {
            font-size: 13px; color: var(--text-60);
            display: flex; align-items: center; gap: 6px;
        }

        .result-badge-check { color: var(--brand); }

        /* â”€â”€ Error â”€â”€ */
        .error-msg {
            padding: 14px 18px; background: #fef2f2;
            border: 1px solid #fecaca; border-radius: 10px;
            font-size: 13px; color: #991b1b; margin-bottom: 20px;
        }

        /* â”€â”€ Footer â”€â”€ */
        .footer {
            margin-top: 56px; text-align: center;
            font-size: 12px; color: var(--text-40); line-height: 1.7;
        }

        @media (max-width: 520px) {
            .headline { font-size: 28px; white-space: normal; }
            .result-layout { gap: 28px; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <svg width="105" height="23" viewBox="0 0 105 23" fill="none" xmlns="http://www.w3.org/2000/svg" style="height:16px;width:auto;">
                <path d="M15.3743 0.408977H8.45517C7.9619 0.408977 7.56238 0.808502 7.56238 1.30177V8.22092C7.56238 8.71419 7.9619 9.11371 8.45517 9.11371H15.3743C15.8676 9.11371 16.2671 8.71419 16.2671 8.22092V1.30177C16.2671 0.808502 15.8676 0.408977 15.3743 0.408977Z" fill="black"/>
                <path d="M6.71435 9.11354H0.893341C0.383333 9.11354 -0.0284702 9.54096 0.00166153 10.051C0.308559 15.266 3.15769 19.8081 7.3248 22.453C7.75 22.7231 8.31468 22.5847 8.57025 22.1506L11.5232 17.1498C11.7642 16.7413 11.6437 16.2157 11.2486 15.9534C9.23873 14.6221 7.84597 12.4314 7.60268 9.90812C7.55916 9.45503 7.17079 9.11354 6.71547 9.11354H6.71435Z" fill="black"/>
                <path d="M35.2818 20.7496V0.408936H38.2973V18.1608H48.3076V20.7496H35.2818Z" fill="black"/>
                <path d="M50.0196 5.81416H52.8929V20.7496H50.0196V5.81416ZM49.9627 3.65207V0.408936H52.9498V3.65207H49.9627Z" fill="black"/>
                <path d="M54.5939 16.1979H57.4388C57.9224 17.791 58.975 18.7582 61.0517 18.7582C62.7587 18.7582 63.9819 17.9901 63.9819 16.653C63.9819 15.2591 62.5595 14.8892 60.4543 14.3772L59.4017 14.0927C56.9267 13.4953 55.0776 12.3858 55.0776 9.79695C55.0776 7.15124 57.4672 5.41588 60.7957 5.41588C64.0957 5.41588 66.2578 6.8383 66.5992 9.7685H63.8682C63.4414 8.43142 62.4457 7.69176 60.7104 7.69176C58.8897 7.69176 58.0078 8.43142 58.0078 9.54092C58.0078 10.7642 58.8897 11.1056 60.7104 11.6461L62.3035 12.1013C65.2906 12.9547 66.8553 13.8651 66.8553 16.3686C66.8553 19.2419 64.3802 21.091 60.9664 21.091C57.325 21.091 55.1913 19.5264 54.5939 16.1979Z" fill="black"/>
                <path d="M72.4861 1.77446V5.81416H75.274V8.03314H72.4861V16.9944C72.4861 18.4453 73.1973 18.8436 74.3068 18.8436C74.5059 18.8436 74.8188 18.8151 75.018 18.7867V20.9203C74.5913 21.0057 74.2783 21.0341 73.9085 21.0341C71.2628 21.0341 69.5843 20.1522 69.5843 17.1651V8.03314H67.3369V5.81416H69.5843V1.77446H72.4861Z" fill="black"/>
                <path d="M90.448 14.0358H78.7556C78.841 16.653 80.6048 18.7298 83.4496 18.7298C85.4979 18.7298 86.4936 17.7625 87.2617 16.4824H90.135C89.31 19.185 86.8919 21.1195 83.3358 21.1195C78.7272 21.1195 75.8539 18.0186 75.8539 13.353C75.8539 8.68746 78.8694 5.38743 83.3358 5.38743C88.2005 5.38743 90.448 9.08574 90.448 13.097V14.0358ZM78.8694 11.7599H87.4609C87.2048 9.37022 85.754 7.72021 83.279 7.72021C80.9177 7.72021 79.1824 9.25643 78.8694 11.7599Z" fill="black"/>
                <path d="M95.0172 5.81416V7.834C95.7853 6.55382 97.2646 5.38743 99.7681 5.38743C103.21 5.38743 105.003 7.69176 105.003 11.5608V20.7496H102.101V12.6418C102.101 9.68316 101.134 7.834 98.7724 7.834C96.3827 7.834 95.0741 9.7685 95.0741 12.1297V20.7496H92.2008V6.9521C92.2008 6.58227 92.2008 6.18399 92.1723 5.81416H95.0172Z" fill="black"/>
            </svg>
        </div>
        <h1 class="headline">Make your PDFs email-ready</h1>
        <p class="subline">Smart compression that preserves live text, hyperlinks, and image clarity.</p>
    </div>

    <!-- Steps -->
    <div class="steps">
        <div class="step"><div class="step-dot active" id="dot-0"></div><span class="step-label active" id="label-0">Upload</span></div>
        <div class="step-line" id="line-0"></div>
        <div class="step"><div class="step-dot" id="dot-1"></div><span class="step-label" id="label-1">Configure</span></div>
        <div class="step-line" id="line-1"></div>
        <div class="step"><div class="step-dot" id="dot-2"></div><span class="step-label" id="label-2">Compress</span></div>
        <div class="step-line" id="line-2"></div>
        <div class="step"><div class="step-dot" id="dot-3"></div><span class="step-label" id="label-3">Download</span></div>
    </div>

    <!-- Error -->
    <div class="error-msg" id="error" style="display:none"></div>

    <!-- Upload -->
    <div class="section visible" id="sec-upload">
        <div class="dropzone" id="dropzone">
            <div class="dropzone-arrow">â†“</div>
            <div class="dropzone-title">Drop your PDF here</div>
            <div class="dropzone-sub">or click to browse Â· up to 200 MB</div>
            <input type="file" accept=".pdf" id="file-input" style="display:none">
        </div>
        <div class="card">
            <div class="card-title">What gets preserved</div>
            <div class="preserves-grid">
                <div class="preserve-item"><span class="preserve-check">âœ“</span> Selectable text</div>
                <div class="preserve-item"><span class="preserve-check">âœ“</span> All hyperlinks</div>
                <div class="preserve-item"><span class="preserve-check">âœ“</span> Font rendering</div>
                <div class="preserve-item"><span class="preserve-check">âœ“</span> Page structure</div>
                <div class="preserve-item"><span class="preserve-check">âœ“</span> Bookmarks</div>
                <div class="preserve-item"><span class="preserve-check">âœ“</span> Image clarity</div>
            </div>
        </div>
    </div>

    <!-- Configure -->
    <div class="section" id="sec-configure">
        <div class="file-info">
            <div class="file-icon">ðŸ“„</div>
            <div class="file-details">
                <div class="file-name" id="file-name"></div>
                <div class="file-size" id="file-size"></div>
            </div>
            <button class="file-remove" onclick="reset()" title="Remove file">Ã—</button>
        </div>

        <!-- Slider -->
        <div class="slider-section">
            <div class="slider-header">
                <span class="slider-label">Compression level</span>
                <span class="slider-level-name" id="level-name">Balanced</span>
            </div>
            <div class="slider-track">
                <input type="range" id="level-slider" min="1" max="7" value="4" step="1">
                <div class="slider-ticks">
                    <span class="slider-tick">Gentle</span>
                    <span class="slider-tick">Maximum</span>
                </div>
            </div>
        </div>

        <!-- Level description -->
        <div class="level-desc">
            <div class="level-desc-text" id="level-desc-text">
                Good compression with high visual quality. Best for most uses.
            </div>
            <div id="raster-badge" style="display:none; padding: 8px 12px; background: #fff3cd; border-radius: 8px; font-size: 12px; color: #856404; margin-bottom: 12px;">
                âš¡ Rasterize mode â€” pages are rendered as images. Much smaller files but text won't be selectable.
            </div>
            <div class="settings-grid">
                <div>Image DPI â†’ <span class="settings-value" id="set-dpi">150</span></div>
                <div>JPEG quality â†’ <span class="settings-value" id="set-jpeg">82%</span></div>
                <div>Stream recompression â†’ <span class="settings-value">on</span></div>
                <div>Strip metadata â†’ <span class="settings-value" id="set-meta">on</span></div>
            </div>
        </div>

        <button class="btn-primary" onclick="startCompress()">Compress PDF</button>
    </div>

    <!-- Compressing -->
    <div class="section" id="sec-compressing">
        <div class="progress-section">
            <div class="progress-ring-wrap">
                <svg width="130" height="130" style="transform:rotate(-90deg)">
                    <circle cx="65" cy="65" r="58" fill="none" stroke="rgba(18,15,8,0.06)" stroke-width="5"/>
                    <circle cx="65" cy="65" r="58" fill="none" stroke="#0021cc" stroke-width="5"
                            stroke-dasharray="364.42" stroke-dashoffset="364.42" stroke-linecap="round"
                            id="progress-circle" style="transition:stroke-dashoffset 0.5s ease"/>
                </svg>
                <div class="progress-pct" id="progress-pct">0%</div>
            </div>
            <div class="progress-label" id="progress-label">Reading PDF structureâ€¦</div>
            <div class="progress-sub">This typically takes a few seconds</div>
        </div>
    </div>

    <!-- Done -->
    <div class="section" id="sec-done">
        <div class="result-card">
            <div class="result-layout">
                <div class="result-ring">
                    <svg width="120" height="120" style="transform:rotate(-90deg)">
                        <circle cx="60" cy="60" r="54" fill="none" stroke="rgba(18,15,8,0.06)" stroke-width="5"/>
                        <circle cx="60" cy="60" r="54" fill="none" stroke="#0021cc" stroke-width="5"
                                stroke-dasharray="339.29" id="result-circle" stroke-linecap="round"/>
                    </svg>
                    <div class="result-pct" id="result-pct"></div>
                    <div class="result-pct-label">smaller</div>
                </div>
                <div class="result-sizes">
                    <div>
                        <div class="result-size-label">Original</div>
                        <div class="result-size-value" id="result-original"></div>
                    </div>
                    <div class="result-divider"></div>
                    <div>
                        <div class="result-size-label">Compressed</div>
                        <div class="result-size-value compressed" id="result-compressed"></div>
                    </div>
                </div>
            </div>
            <div class="result-badges">
                <div class="result-badge"><span class="result-badge-check">âœ“</span> Live text</div>
                <div class="result-badge"><span class="result-badge-check">âœ“</span> Hyperlinks</div>
                <div class="result-badge"><span class="result-badge-check">âœ“</span> Fonts preserved</div>
            </div>
        </div>
        <div class="btn-row" id="btn-row-done"></div>
    </div>

    <div class="footer" style="font-size:10px;">
        Â© 2026 Listen Labs
    </div>
</div>

<script>
    let selectedFile = null;
    let selectedLevel = '4';
    let compressedBlob = null;
    let compressedName = '';

    const levels = {
        '1': { name: 'Lossless cleanup',  dpi: 300, jpeg: 95, meta: false, raster: false, desc: 'Removes unused objects and recompresses streams. No image quality loss at all. Smallest file size reduction.' },
        '2': { name: 'High quality',      dpi: 250, jpeg: 92, meta: false, raster: false, desc: 'Very gentle image resampling. Visually indistinguishable from the original in almost all cases.' },
        '3': { name: 'Quality',           dpi: 200, jpeg: 88, meta: true,  raster: false, desc: 'Light compression with minimal visual impact. Good for documents you want to look sharp.' },
        '4': { name: 'Balanced',          dpi: 150, jpeg: 82, meta: true,  raster: false, desc: 'Good compression with high visual quality. Best for most uses.' },
        '5': { name: 'Email-ready',       dpi: 120, jpeg: 72, meta: true,  raster: false, desc: 'Compresses images and removes metadata. Text stays selectable. Good for most email needs.' },
        '6': { name: 'Aggressive',        dpi: 150, jpeg: 80, meta: true,  raster: true,  desc: 'Renders pages as images for maximum compression. Great for design-heavy decks. Text is no longer selectable.' },
        '7': { name: 'Maximum',           dpi: 120, jpeg: 65, meta: true,  raster: true,  desc: 'Lowest file size possible. Pages rendered as compressed images. Best when file size is the only priority.' },
    };

    // â”€â”€ Helpers â”€â”€

    function formatBytes(b) {
        if (b === 0) return '0 B';
        const k = 1024, s = ['B','KB','MB','GB'];
        const i = Math.floor(Math.log(b) / Math.log(k));
        return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + s[i];
    }

    function showSection(name) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('visible'));
        document.getElementById('sec-' + name).classList.add('visible');
        const map = { upload: 0, configure: 1, compressing: 2, done: 3 };
        const cur = map[name];
        for (let i = 0; i < 4; i++) {
            document.getElementById('dot-' + i).classList.toggle('active', i <= cur);
            document.getElementById('label-' + i).classList.toggle('active', i <= cur);
        }
        for (let i = 0; i < 3; i++) {
            document.getElementById('line-' + i).classList.toggle('active', i < cur);
        }
    }

    function showError(msg) {
        const el = document.getElementById('error');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 6000);
    }

    // â”€â”€ Drop Zone â”€â”€

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragging'); });
    dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragging'); });
    dropzone.addEventListener('drop', e => {
        e.preventDefault(); dropzone.classList.remove('dragging');
        const f = e.dataTransfer.files[0];
        if (f && f.type === 'application/pdf') handleFile(f);
        else showError('Please drop a PDF file.');
    });
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) handleFile(fileInput.files[0]); });

    function handleFile(file) {
        selectedFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatBytes(file.size);
        document.getElementById('error').style.display = 'none';
        showSection('configure');
    }

    // â”€â”€ Slider â”€â”€

    const slider = document.getElementById('level-slider');

    function updateLevel() {
        selectedLevel = slider.value;
        const lv = levels[selectedLevel];
        document.getElementById('level-name').textContent = lv.name;
        document.getElementById('level-desc-text').textContent = lv.desc;
        document.getElementById('set-dpi').textContent = lv.dpi;
        document.getElementById('set-jpeg').textContent = lv.jpeg + '%';
        document.getElementById('set-meta').textContent = lv.meta ? 'on' : 'off';

        // Show raster warning for levels 6-7
        const rasterBadge = document.getElementById('raster-badge');
        if (rasterBadge) rasterBadge.style.display = lv.raster ? 'block' : 'none';
    }

    slider.addEventListener('input', updateLevel);

    // â”€â”€ Compression â”€â”€

    function setProgress(pct, label) {
        const circ = document.getElementById('progress-circle');
        circ.setAttribute('stroke-dashoffset', 364.42 - (pct / 100) * 364.42);
        document.getElementById('progress-pct').textContent = pct + '%';
        if (label) document.getElementById('progress-label').textContent = label;
    }

    async function startCompress() {
        showSection('compressing');
        compressedBlob = null;

        const steps = [
            { label: 'Reading PDF structureâ€¦', pct: 8 },
            { label: 'Analyzing embedded imagesâ€¦', pct: 20 },
            { label: 'Recompressing imagesâ€¦', pct: 45 },
            { label: 'Preserving transparencyâ€¦', pct: 60 },
            { label: 'Deduplicating objectsâ€¦', pct: 75 },
            { label: 'Optimizing streamsâ€¦', pct: 90 },
        ];

        let stepIdx = 0;
        const ticker = setInterval(() => {
            if (stepIdx < steps.length) {
                setProgress(steps[stepIdx].pct, steps[stepIdx].label);
                stepIdx++;
            }
        }, 800);

        try {
            const form = new FormData();
            form.append('file', selectedFile);
            form.append('level', selectedLevel);

            const resp = await fetch('/compress', { method: 'POST', body: form });
            clearInterval(ticker);

            if (!resp.ok) {
                const err = await resp.json().catch(() => null);
                throw new Error(err?.error || 'Compression failed');
            }

            compressedBlob = await resp.blob();
            compressedName = selectedFile.name.replace(/\.pdf$/i, '-compressed.pdf');

            setProgress(100, 'Done!');
            setTimeout(() => showResults(selectedFile.size, compressedBlob.size), 350);
        } catch (err) {
            clearInterval(ticker);
            showError(err.message || 'Something went wrong. Please try again.');
            showSection('configure');
        }
    }

    function showResults(originalSize, compressedSize) {
        const savings = Math.max(0, Math.round((1 - compressedSize / originalSize) * 100));

        const circ = document.getElementById('result-circle');
        circ.setAttribute('stroke-dashoffset', 339.29 - (savings / 100) * 339.29);

        document.getElementById('result-pct').textContent = savings + '%';
        document.getElementById('result-original').textContent = formatBytes(originalSize);
        document.getElementById('result-compressed').textContent = formatBytes(compressedSize);

        const row = document.getElementById('btn-row-done');
        row.innerHTML = '';

        if (compressedBlob) {
            const dl = document.createElement('button');
            dl.className = 'btn-primary';
            dl.style.flex = '1';
            dl.textContent = 'Download compressed PDF';
            dl.onclick = downloadResult;
            row.appendChild(dl);
        }

        const again = document.createElement('button');
        again.className = 'btn-secondary';
        again.textContent = compressedBlob ? 'New file' : 'Compress another PDF';
        again.onclick = reset;
        row.appendChild(again);

        showSection('done');
    }

    function downloadResult() {
        if (!compressedBlob) return;
        const url = URL.createObjectURL(compressedBlob);
        const a = document.createElement('a');
        a.href = url; a.download = compressedName; a.click();
        URL.revokeObjectURL(url);
    }

    function reset() {
        selectedFile = null; compressedBlob = null; compressedName = '';
        fileInput.value = '';
        slider.value = '4'; updateLevel();
        setProgress(0, 'Reading PDF structureâ€¦');
        document.getElementById('error').style.display = 'none';
        showSection('upload');
    }
</script>

</body>
</html>
